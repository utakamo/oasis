#!/usr/bin/env lua

--[[

# Oasis Local Tool (OLT) Server (Lua Script Ver)
 This server script is based on concepts inspired by the Model Context Protocol and Agents.json.
 By leveraging UBUS, an integral part of the OpenWrt ecosystem, the client and server can cooperate
 to allow the AI to access the tools it provides.
 On OpenWrt systems with Oasis and oasis-mod-tool installed, third-party developers can easily expose
 tools to the AI by simply downloading server scripts.

# Rules for defining tools in the local tool server
    - Rule 1. 
        If a tool requires arguments, you must specify a type string for each argument.

        Reference:
        1. string type  ---> "a_string"
        TODO: Investigate data type specifications other than "a_string" and add them here. 

    - Rule 2. 
        The table returned by server.response must be an associative array (key-value pairs).

        Example: 
        server.response({reply = "Hello Tool Client!"})

# Note
 This script is loaded by the `rpcd` module and registered with `ubusd` as a UBUS object.  

# Important
 Please avoid defining global functions in ubus server scripts.
 For AI tool scripts used in Oasis (like this one), write your logic using server.tool.
 If you need to create custom functions, put them inside the call field of the table that’s passed as the second argument to server.tool.
 The same rule applies when using require to load external libraries—make sure to call require inside the call field too.

 About rpcd lua plugin:
 https://github.com/openwrt/luci/blob/37ea60da580490a4d8178134297152661f25151d/applications/luci-app-example/root/usr/libexec/rpcd/luci.example
]]

local server = require("oasis.local.tool.server")

server.tool("show_service_list", {
    tool_desc = "Show service list",
    call = function()
        local util = require("luci.util")
        local list = util.exec("service")
        return server.response(
            {
                result = list
            }
        )
    end
})

server.tool("set_service_enable", {
    tool_desc = "Request a Restart of the Specified Service on the OpenWrt System.",
    args_desc = { "Target Service Name [ex: network]" },
    args = { service = "a_string"},
    call = function(args)
        // TODO: check whether the target service exists
        // TODO: Check the service status (is it already in the desired state?)
        return server.response(
            {
                result = "The OpenWrt system has accepted the shutdown request. Inform the user that the shutdown will proceed once they grant permission.",
                prepare_service_enable = args.service
            }
        )
    end
})

server.tool("set_service_disabled", {
    tool_desc = "Request a Restart of the Specified Service on the OpenWrt System.",
    args_desc = { "Target Service Name [ex: network]" },
    args = { service = "a_string"},
    call = function(args)
        // TODO: check whether the target service exists
        // TODO: Check the service status (is it already in the desired state?)
        return server.response(
            {
                result = "The OpenWrt system has accepted the shutdown request. Inform the user that the shutdown will proceed once they grant permission.",
                prepare_service_disable = args.service
            }
        )
    end
})

server.tool("service_stop", {
    tool_desc = "Request a Restart of the Specified Service on the OpenWrt System.",
    args_desc = { "Target Service Name [ex: network]" },
    args = { service = "a_string"},
    call = function(args)
        // TODO: check whether the target service exists
        // TODO: Check the service status (is it already in the desired state?)
        return server.response(
            {
                result = "The OpenWrt system has accepted the shutdown request. Inform the user that the shutdown will proceed once they grant permission.",
                prepare_service_stop = args.service
            }
        )
    end
})

server.tool("service_start", {
    tool_desc = "Request a Restart of the Specified Service on the OpenWrt System.",
    args_desc = { "Target Service Name [ex: network]" },
    args = { service = "a_string"},
    call = function(args)
        // TODO: check whether the target service exists
        // TODO: Check the service status (is it already in the desired state?)
        return server.response(
            {
                result = "The OpenWrt system has accepted the shutdown request. Inform the user that the shutdown will proceed once they grant permission.",
                prepare_service_start = args.service
            }
        )
    end
})

server.tool("service_restart", {
    tool_desc = "Request a Restart of the Specified Service on the OpenWrt System.",
    args_desc = { "Target Service Name [ex: network]" },
    args = { service = "a_string"},
    call = function(args)
        // TODO: check whether the target service exists
        // TODO: Check the service status (is it already in the desired state?)
        return server.response(
            {
                result = "The OpenWrt system has accepted the shutdown request. Inform the user that the shutdown will proceed once they grant permission.",
                prepare_service_restart = args.service
            }
        )
    end
})

server.tool("operate", {
    tool_desc = "Operations on the target service",
    args_desc = { "Target Service Name [ex: network]", "Operation Command [\"enable\" or \"disable\" or \"stop\" or \"start\" or \"restart\"]" },
    args = { service = "a_string", cmd = "a_string" },
    call = function(args)
        local util = require("luci.util")
        local guard = require("oasis.security.guard")
        local misc  = require("oasis.chat.misc")

        local list = util.exec("service")

        local cmd = args.cmd
        local service = args.service

        local service_exists = false
        for line in string.gmatch(list, "[^\n]+") do
            if string.match(line, "^/etc/init.d/" .. service .. "%s") then
                service_exists = true
                break
            end
        end

        if not service_exists then
            return server.response({result = "The specified service does not exist.", status = "NG"})
        end

        local svc = guard.sanitize(service)

        if cmd == "enable" then
            local out = util.exec("/etc/init.d/" .. svc .. " enable 2>&1; echo $?")
            out = out and out:gsub("%s+$", "") or ""
            local rc = tonumber(out:match("(%d+)%s*$")) or -1
            local ok = (rc == 0)
            return server.response({
                result = ok and "The OpenWrt system has enabled the service." or ("Failed to enable service: " .. out),
                status = ok and "OK" or "NG",
            })

        elseif cmd == "disable" then
            local out = util.exec("/etc/init.d/" .. svc .. " disable 2>&1; echo $?")
            out = out and out:gsub("%s+$", "") or ""
            local rc = tonumber(out:match("(%d+)%s*$")) or -1
            local ok = (rc == 0)
            return server.response({
                result = ok and "The OpenWrt system has disabled the service." or ("Failed to disable service: " .. out),
                status = ok and "OK" or "NG",
            })

        elseif cmd == "stop" then
            local out = util.exec("/etc/init.d/" .. svc .. " stop 2>&1; echo $?")
            out = out and out:gsub("%s+$", "") or ""
            local rc = tonumber(out:match("(%d+)%s*$")) or -1
            local ok = (rc == 0)
            return server.response({
                result = ok and "The OpenWrt system has accepted the stop request. The service will be stopped." or ("Failed to stop service: " .. out),
                status = ok and "OK" or "NG",
            })

        elseif cmd == "start" then
            local out = util.exec("/etc/init.d/" .. svc .. " start 2>&1; echo $?")
            out = out and out:gsub("%s+$", "") or ""
            local rc = tonumber(out:match("(%d+)%s*$")) or -1
            local ok = (rc == 0)
            return server.response({
                result = ok and "The OpenWrt system has accepted the run request. The service will be started." or ("Failed to start service: " .. out),
                status = ok and "OK" or "NG",
                output = out,
                rc = rc
            })

        elseif cmd == "restart" then
            return server.response({
                result = "The system requests confirmation to restart the specified service.",
                status = "OK"
            })
        end

        return server.response(
            {
                result = "Invalid command specified. Supported commands are: enable, disable, stop, run, restart.",
                status = "NG"
            }
        )
    end
})

server.run(arg)
