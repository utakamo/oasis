Oasis employs a dedicated data structure to centrally manage chat data across multiple AI services.
This structure functions as an unified schema, enabling seamless switching between AI services
during a conversation and allowing users to resume chats by loading past data.

The chat data structure in Oasis is modeled after OpenAI’s format and follows the JSON schema shown
below. As a result, it is directly compatible with OpenAI and other AI services that adopt similar specifications.

However, services such as Gemini and Anthropic differ significantly from OpenAI’s JSON format,
requiring conversion of incompatible elements. These conversion processes are individually implemented
within service-specific modules (e.g., openai.lua, ollama.lua, gemini.lua, Anthropic ).

[Send & Set Message Data to LLM]
                               ------------------------------                                                 ------------
                              |                              | ----> | convert schema <openai.lua>    | ---> |            |            
 ------      message data     |                              | ----> | convert schema <ollama.lua>    | ---> |            |          
| User | ---- main.lua------> |   oasis unified chat schema  | ----> | convert schema <gemini.lua>    | ---> |  transfer  | ---> LLM
 ------                       |                              | ----> | convert schema <anthropic.lua> | ---> |            |
                              |                              | ----> | convert schema <openrouter.lua>| ---> |            |       
                               -----------------------------                                                  ------------

[Receive & Save Message data from LLM]
                               -----------------------------                                                  -----------
                              |                             | <---- | convert schema <openai.lua>     | <--- |           |
 ------      message data     |                             | <---- | convert schema <ollama.lua>     | <--- |           |
| User | <--- main.lua ------ |  oasis unified chat schema  | <---- | convert schema <gemini.lua>     | <--- | transfer  | <--- LLM
 ------         |             |                             | <---- | convert schema <anthropic.lua>  | <--- |           |
                |             |                             | <---- | convert schema <openrouter.lua> | <--- |           |
                |              -----------------------------                                                  -----------
                |
                |                            
                | Save chat Data
                |              -----------------------------
                |             |                             |
                 -----------> |         data control        |
                              |                             |
                               -----------------------------

# 1. Normal Conversation

--------------------------------------
- [Oasis unified chat schema Format] -
--------------------------------------
{
  "messages": [
    {
      "content": "system message (knowledge)",
      "role": "system"
    },
    {
      "content": "user first message",
      "role": "user"
    },
    {
      "content": "ai first response",
      "role": "assistant"
    },
    {
      "content": "user second message",
      "role": "user"
    },
    {
      "content": "ai second response",
      "role": "assistant"
    }
  ]
}

-----------
- Example -
-----------
{
  "messages": [
    {
      "content": "You are an OpenWrt teacher. \nPlease answer users' questions politely. Also, when a user requests a configuration change, please provide instructions on how to change the settings using UCI commands. \n\nThe UCI commands that you output as code are executed by software called Oasis. \nWhen Oasis runs UCI commands, it automatically executes the relevant uci commit command and /etc/init.d scripts.\n\nTherefore, you do not need to display the uci commit command to the user.\n",
      "role": "system"
    },
    {
      "content": "Hello",
      "role": "user"
    },
    {
      "content": "Hello! Welcome to the world of OpenWrt! What can I help you with today? Do you have any questions about configuring your router or need guidance on a specific task? \n\nI'm ready to answer any questions you might have and offer assistance in setting up your OpenWrt experience.\n",
      "role": "assistant"
    },
    {
      "content": "Nice to meet you. My name is utakamo.",
      "role": "user"
    },
    {
      "content": "Hello Utakamo! Nice to meet you too! It's a pleasure to help you with your OpenWrt setup. What are you hoping to learn or achieve today? \n\n\nLet me know if you have any questions about getting started, configuring services, setting up specific features like DDNS or VPNs, or anything else related to OpenWrt. \n",
      "role": "assistant"
    }
  ]
}

# 2. Tool Use (Function Calling)
This section documents the tool invocation output format used by Oasis. The external format is similar to OpenAI's function calling: each tool invocation produces an entry in the `tool_outputs` array. Oasis stores the tool-returned payload in the `output` field as a JSON-encoded string.

Schema (summary)
- `service` : AI service name (e.g. `Ollama`, `OpenAI`).
- `tool_outputs` : array of tool invocation result objects.
- per-entry fields: `tool_call_id` (string), `name` (string), `output` (string containing JSON).

Processing rules
- Consumers MUST JSON-parse the `output` string before interpreting tool data.
- Services and modules are responsible for validating and converting tool-specific schemas into the oasis unified chat schema as needed. Tool implementations may vary; do not assume a fixed sub-schema inside `output`.
- Certain field names inside the parsed `output` are reserved or treated specially by Oasis components (for example, `user_only`). Using these reserved names can influence message visibility, rendering, or subsequent processing.

Operational considerations
- Size and nesting: `output` may contain large or deeply nested objects. Implementations should guard against excessive memory use and consider truncation/streaming if necessary.
- Security: treat parsed data as untrusted. Validate types and sizes, and sanitize fields before executing any side effects or rendering.
- Responsibility: service modules (e.g. `oasis-mod-tool`) are the correct place to implement tool-specific parsing, validation, and conversion logic.

Reference
For service-specific behavior and a list of fields treated specially by Oasis, see the oasis-mod-tool repository:
https://github.com/utakamo/oasis/tree/main/oasis-mod-tool

Example (external payload):
{
  "service": "oasis.lua.tool.server",
  "tool_outputs": [
    {
      "tool_call_id": "123",
      "name": "get_weather",
      "output": "{\"result\":\"It's 22°C in Tokyo.\"}"
    }
  ]
}