<%+header%>

<style>
  /* Layout */
  #oasis-tool-container { display: flex; flex-direction: column; align-items: center; }
  h2 { margin: 0 0 8px; }
  h3 { margin: 0; font-size: 1rem; color: #555; }
  .server-block { width: 100%; max-width: 760px; margin-top: 22px; }
  /* Head action container: same width as server-block but dedicated for refresh button */
  .tools-head-block { width: 100%; max-width: 760px; margin: 8px auto; }
  .server-header { display:flex; align-items:center; justify-content: space-between; margin-bottom: 8px; }
  .list { display:flex; flex-direction:column; gap: 12px; width:100%; margin-top: 8px; }

  /* Card */
  .cell { background:#fff; border-radius:12px; box-shadow: 0 4px 10px rgba(0,0,0,0.06); padding: 14px 16px; display:flex; flex-direction:column; gap:10px; }
  .cell-title { color:#333; font-weight:700; font-size: 1.05rem; display:flex; align-items:center; gap:8px; }
  .status-pill { font-size: 12px; padding: 2px 8px; border-radius: 999px; background:#e9ecef; color:#495057; }
  .status-pill.enabled { background:#d1e7dd; color:#0f5132; }
  .pill-conflict { font-size: 12px; padding: 2px 8px; border-radius: 999px; background:#ff4da6; color:#ffffff; }
  .pill-script { font-size: 12px; padding: 2px 8px; border-radius: 999px; color:#ffffff; }
  .pill-script.script-lua { background:#2a84ff; }
  .pill-script.script-ucode { background:#7b61ff; }
  .cell-description { font-size: 0.92rem; color:#444; line-height:1.45; }
  .cell-footer { display:flex; justify-content:flex-end; align-items:center; }

  /* Unified button styles */
  .add-button, .load-button, .update-button, .delete-button, .cancel-button {
    display: inline-block; padding: 0 14px; width: 7.5rem; height: 2.5rem; line-height: 2.5rem; color: #ffffff; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;
  }
  .load-button { background: linear-gradient(180deg, #2a84ff 0%, #0d6efd 100%); }
  .delete-button, .cancel-button { background: linear-gradient(180deg, #9aa0a6 0%, #80868b 100%); }
  .load-button:active, .delete-button:active, .cancel-button:active { transform: translateY(1px); }
  /* Full width variant for head action */
  .load-button.fullwidth { width: 100%; }

  /* Toast */
  .toast { position: sticky; top: 8px; background:#212529; color:#fff; padding:10px 12px; border-radius:8px; margin-bottom:8px; display:none; z-index: 10; }
  .toast.show { display:block; }
  .toast.success { background:#198754; }
  .toast.error { background:#dc3545; }
  .toast.info { background:#0d6efd; }

  /* Simple error modal */
  .tools-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 1300; }
  .tools-modal.show { display: flex; }
  .tools-card { background: #ffffff; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); padding: 18px 20px; width: min(92vw, 420px); }
  .tools-card p { margin: 0 0 12px; font-weight: 600; text-align: center; }
  .form-actions { margin: 10px 0; display:flex; gap:10px; flex-wrap: wrap; }
</style>

<div id="tools-toast" role="status" aria-live="polite" class="toast" aria-atomic="true"></div>
<h2>Local Tools</h2>
<div id="oasis-tool-container"></div>

<!-- Error dialog -->
<div id="tools-error-modal" class="tools-modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="tools-card">
    <p id="tools-error-message">An error occurred.</p>
    <div class="form-actions" style="justify-content:center;">
      <button type="button" id="tools-error-ok" class="delete-button">OK</button>
    </div>
  </div>
  
</div>

<!--
<h2>Remote MCP Server</h2>
<div id="oasis-mcp-containe"></div>
-->

<script>
(function() {
  const container = document.getElementById('oasis-tool-container');
  const toastEl = document.getElementById('tools-toast');
  const header = document.querySelector('h2');
  const API_ENABLE = '<%=build_url("admin", "network", "oasis", "enable-tool")%>';
  const API_DISABLE = '<%=build_url("admin", "network", "oasis", "disable-tool")%>';
  const errorModal = document.getElementById('tools-error-modal');
  const errorMsgEl = document.getElementById('tools-error-message');
  const errorOkBtn = document.getElementById('tools-error-ok');

  function showToast(message, type = 'info', timeout = 2000) {
    if (!toastEl) return;
    toastEl.textContent = message;
    toastEl.className = `toast show ${type}`;
    setTimeout(() => { toastEl.className = 'toast'; toastEl.textContent = ''; }, timeout);
  }

  function showErrorModal(message) {
    if (errorMsgEl) errorMsgEl.textContent = message || 'An error occurred.';
    if (errorModal) {
      errorModal.classList.add('show');
      errorModal.setAttribute('aria-hidden', 'false');
    }
  }
  if (errorOkBtn) {
    errorOkBtn.addEventListener('click', function() {
      errorModal.classList.remove('show');
      errorModal.setAttribute('aria-hidden', 'true');
    });
  }

  function createServerBlock(serverName, tools) {
    const block = document.createElement('div');
    block.className = 'server-block';

    const headerWrap = document.createElement('div');
    headerWrap.className = 'server-header';
    const header = document.createElement('h3');
    header.textContent = serverName;
    headerWrap.appendChild(header);
    block.appendChild(headerWrap);

    const list = document.createElement('div');
    list.className = 'list';

    tools.forEach(tool => {
      list.appendChild(createCard(tool));
    });

    block.appendChild(list);
    return block;
  }

  function createCard(tool) {
    const cell = document.createElement('div');
    cell.className = 'cell';

    const title = document.createElement('div');
    title.className = 'cell-title';
    const titleText = document.createElement('span');
    titleText.textContent = tool.name || 'Unknown';
    const status = document.createElement('span');
    status.className = 'status-pill' + ((tool.enable === '1') ? ' enabled' : '');
    status.textContent = (tool.enable === '1') ? 'Enabled' : 'Disabled';
    title.appendChild(titleText);
    // script badge (lua -> blue, ucode -> purple)
    if (tool.script === 'lua' || tool.script === 'ucode') {
      const script = document.createElement('span');
      script.className = 'pill-script ' + (tool.script === 'lua' ? 'script-lua' : 'script-ucode');
      script.textContent = (tool.script === 'ucode') ? 'ucode' : tool.script;
      title.appendChild(script);
    }
    // Show conflict badge when conflict === '1'
    const isConflict = (tool.conflict === '1');
    if (isConflict) {
      const conflict = document.createElement('span');
      conflict.className = 'pill-conflict';
      conflict.textContent = 'conflict';
      title.appendChild(conflict);
    }
    // enable/disable status at the end
    title.appendChild(status);

    const desc = document.createElement('div');
    desc.className = 'cell-description';
    desc.textContent = tool.description || 'No description.';

    const footer = document.createElement('div');
    footer.className = 'cell-footer';

    const btn = document.createElement('button');
    let isEnabled = tool.enable === '1';
    btn.className = isEnabled ? 'delete-button' : 'load-button';
    btn.textContent = isEnabled ? 'Disable' : 'Enable';
    if (isConflict) {
      btn.disabled = true;
      btn.title = 'Conflict: cannot change state';
    }

    btn.addEventListener('click', () => {
      if (isConflict) return;
      if (!tool.name) { showToast('Missing tool name', 'error'); return; }
      const enabling = !isEnabled; // current button action
      const url = enabling ? API_ENABLE : API_DISABLE;
      const prevText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Loading...';
      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ name: tool.name, server: tool.server || '' })
      })
      .then(r => r.json())
      .then(data => {
        if (!data || data.status !== 'OK') throw new Error((data && data.error) || 'Unexpected response');
        // apply UI only on success
        isEnabled = enabling;
        btn.textContent = isEnabled ? 'Disable' : 'Enable';
        btn.className = isEnabled ? 'delete-button' : 'load-button';
        status.textContent = isEnabled ? 'Enabled' : 'Disabled';
        status.className = 'status-pill' + (isEnabled ? ' enabled' : '');
      })
      .catch(err => {
        console.error('toggle failed:', err);
        showErrorModal(err && err.message ? err.message : 'Failed to update tool state');
        btn.textContent = prevText;
      })
      .finally(() => { btn.disabled = false; });
    });

    footer.appendChild(btn);
    cell.appendChild(title);
    cell.appendChild(desc);
    cell.appendChild(footer);

    return cell;
  }

  function loadTools() {
    fetch('<%=build_url("admin", "network", "oasis", "local-tool-info")%>')
      .then(response => response.json())
      .then(data => {
        if (data && data.local_tool === false) {
          if (container) {
            container.innerHTML = '';
            const p = document.createElement('p');
            p.textContent = "Please install the extension module 'oasis-mod-tool' to enable local tools.";
            container.appendChild(p);
          }
          return;
        }
        // local_tool is enabled: add Refresh button at top (centered, full width like server blocks)
        if (header) {
          const bar = document.createElement('div');
          bar.className = 'tools-head-block';
          bar.style.display = 'flex';
          bar.style.justifyContent = 'center';

          const btn = document.createElement('button');
          btn.className = 'load-button fullwidth';
          btn.textContent = 'Refresh';
          btn.addEventListener('click', () => {
            btn.disabled = true;
            btn.textContent = 'Running...';
            fetch('<%=build_url("admin", "network", "oasis", "refresh-tools")%>', { method: 'POST' })
              .then(r => r.json())
              .then(res => {
                if (!res || res.status !== 'OK') throw new Error('Failed to refresh services');
                // After service restart, reload page to reflect changes
                location.reload();
              })
              .catch(err => {
                console.error('refresh-tools failed:', err);
                showToast('Failed to refresh services', 'error', 3000);
                btn.disabled = false;
                btn.textContent = 'Reflesh';
              });
          });
          bar.appendChild(btn);
          header.parentNode.insertBefore(bar, header.nextSibling);
        }
        const tools = data.tools || {};
        const serverMap = {};

        Object.values(tools).forEach(tool => {
          if (tool[".type"] === "tool" && tool.type === "function") {
            const server = tool.server || 'Unknown Server';
            if (!serverMap[server]) serverMap[server] = [];
            serverMap[server].push(tool);
          }
        });

        Object.entries(serverMap).forEach(([server, serverTools]) => {
          const block = createServerBlock(server, serverTools);
          container.appendChild(block);
        });
      })
      .catch(err => {
        console.error('Failed to load server info:', err);
      });
  }

  loadTools();
})();
</script>

<%+footer%>
