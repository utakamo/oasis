#!/bin/sh
#
# Usage:
#    root@OpenWrt:~# oasis_reflesh_install [mode]
#
# Description:
#   This script removes old versions of Oasis packages, installs new ones,
#   and restarts related services.
#
#   If you pass the keyword "migrate" as an argument, the script will:
#     1. Backup the current Oasis UCI configuration before removing packages.
#     2. Restore the configuration after the new installation.
#
# Examples:
#   oasis_reflesh_install
#       -> Normal update (no data migration).
#
#   oasis_reflesh_install migrate
#       -> Update with data migration (backup + restore).
#

MODE="$1"

# Backup configuration if migrate mode is enabled
if [ "$MODE" = "migrate" ]; then
    mkdir -p /tmp/oasis
    touch /tmp/oasis/backup
    uci export oasis > /tmp/oasis/backup
fi

# Remove old versions
opkg remove luci-app-oasis
opkg remove oasis-mod-tool
opkg remove oasis

# Install new versions
opkg install oasis_3.2.4-r1_all.ipk
opkg install luci-app-oasis_3.2.4-r1_all.ipk
opkg install oasis-mod-tool_1.1.0-r1_all.ipk

# Restore configuration if migrate mode is enabled
if [ "$MODE" = "migrate" ]; then
    uci -f /tmp/oasis/backup import oasis
fi

# Restart services
service olt_tool restart
service rpcd restart
