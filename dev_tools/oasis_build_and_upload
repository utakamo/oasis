#!/usr/bin/env bash
set -euo pipefail

REFRESH_SCRIPT_DIR="$(pwd)"

# --------------------------------------------------------------------
# Oasis Build & Upload Automation Script
#
# Usage:
#   ./oasis_build_and_upload.sh
#       → Runs automatically using saved settings (if available).
#
#   ./oasis_build_and_upload.sh --reset
#       → Deletes stored settings and asks for inputs again.
#
# Requirements:
#   - OpenWrt build environment set up correctly
#   - sshpass installed (required for automated SCP password auth)
#
# If sshpass is missing, this script will tell you how to install it.
# --------------------------------------------------------------------

# ====================================
# Check Required Commands
# ====================================
if ! command -v sshpass >/dev/null 2>&1; then
  echo "❌ ERROR: 'sshpass' is not installed."
  echo
  echo "Install it using one of the following commands depending on your OS:"
  echo
  echo "Ubuntu / Debian:"
  echo "  sudo apt update && sudo apt install -y sshpass"
  echo
  echo "CentOS / RHEL:"
  echo "  sudo yum install -y epel-release && sudo yum install -y sshpass"
  echo
  echo "Fedora:"
  echo "  sudo dnf install -y sshpass"
  echo
  echo "Arch Linux:"
  echo "  sudo pacman -S sshpass"
  echo
  echo "macOS (Homebrew):"
  echo "  brew install hudochenkov/sshpass/sshpass"
  echo
  echo "After installing sshpass, run this script again."
  exit 1
fi

# ====================================
# Package Version Variables
# ====================================
OASIS_VER="3.2.6-r1"
LUCIOASIS_VER="3.2.6-r1"
TOOL_VER="1.1.1-r1"
RETIRED_VER="1.0.0-r1"
EDGE_VER="1.0.0-r1"
TEST_VER="1.0.0-r1"

# ====================================
# Config File (User Home)
# ====================================
CONFIG_DIR="$HOME/oasis_build_and_upload"
CONFIG_FILE="$CONFIG_DIR/deploy-oasis.conf"

mkdir -p "$CONFIG_DIR"
chmod 700 "$CONFIG_DIR"

# ====================================
# --reset option
# ====================================
if [[ "${1:-}" == "--reset" ]]; then
  echo "Resetting stored settings..."
  rm -f "$CONFIG_FILE"
  echo "Done. Re-run the script to set up again."
  exit 0
fi

# ====================================
# Load or Create Config
# ====================================
if [[ ! -f "$CONFIG_FILE" ]]; then
  echo "# Auto-generated config file" > "$CONFIG_FILE"
  chmod 600 "$CONFIG_FILE"
fi

source "$CONFIG_FILE"

# ====================================
# BASE setup
# ====================================
if [[ -z "${BASE:-}" ]]; then
  echo "You need to set the .ipk directory path (BASE)."
  read -rp "Enter the path to the .ipk directory (BASE): " BASE
  echo "BASE=\"$BASE\"" >> "$CONFIG_FILE"
  echo "Saved BASE in config."
fi

echo "Using BASE directory: $BASE"

# ====================================
# IP setup
# ====================================
if [[ -z "${TARGET_IP:-}" ]]; then
  read -rp "Enter target device IP (default: 192.168.1.1): " TARGET_IP
  TARGET_IP="${TARGET_IP:-192.168.1.1}"
  echo "TARGET_IP=\"$TARGET_IP\"" >> "$CONFIG_FILE"
  echo "Saved TARGET_IP in config."
fi

# ====================================
# Password setup
# ====================================
if [[ -z "${SSH_PASS:-}" ]]; then
  read -rsp "Enter SSH password: " SSH_PASS
  echo
  echo "SSH_PASS=\"$SSH_PASS\"" >> "$CONFIG_FILE"
  echo "Saved SSH_PASS in config."
fi

chmod 600 "$CONFIG_FILE"

echo
echo "--------------------------------------"
echo "Target Host : $TARGET_IP"
echo "Password    : (hidden)"
echo "BASE Path   : $BASE"
echo "Config File : $CONFIG_FILE"
echo "--------------------------------------"
echo

read -rp "Proceed with these settings? (Y/N): " CONFIRM
case "$CONFIRM" in
  Y|y|yes|YES) ;;
  *) echo "Cancelled."; exit 1 ;;
esac

# ====================================
# Detect OpenWrt Root
# ====================================
OPENWRT_DIR=$(echo "$BASE" | sed 's|\(.*openwrt\).*|\1|')
cd "$OPENWRT_DIR"

# ====================================
# Build
# ====================================
make package/oasis/{clean,compile}
make package/oasis-mod-tool/{clean,compile}
make package/oasis-mod-retired/{clean,compile}
make package/luci-app-oasis/{clean,compile}
make package/oasis-tool-edge/{clean,compile}
make package/oasis-mod-test/{clean,compile}

# ====================================
# Upload .ipk files
# ====================================
FILES=(
  "oasis_${OASIS_VER}_all.ipk"
  "luci-app-oasis_${LUCIOASIS_VER}_all.ipk"
  "oasis-mod-tool_${TOOL_VER}_all.ipk"
  "oasis-mod-retired_${RETIRED_VER}_all.ipk"
  "oasis-tool-edge_${EDGE_VER}_all.ipk"
  "oasis-mod-test_${TEST_VER}_all.ipk"
)

for f in "${FILES[@]}"; do
  src="$BASE/$f"
  [[ -f "$src" ]] && sshpass -p "$SSH_PASS" scp "$src" "root@$TARGET_IP:/root/" || echo "Skipping missing file: $f"
done

# ====================================
# Upload oasis_reflesh_install script
# ====================================
REFRESH_SCRIPT="$REFRESH_SCRIPT_DIR/oasis_reflesh_install"

if [[ -f "$REFRESH_SCRIPT" ]]; then
  echo "Uploading oasis_reflesh_install..."
  sshpass -p "$SSH_PASS" scp "$REFRESH_SCRIPT" "root@$TARGET_IP:/root/"
  echo "✅ oasis_reflesh_install uploaded."
else
  echo "⚠️ oasis_reflesh_install not found: $REFRESH_SCRIPT"
fi

echo
echo "✅ Upload complete."
echo
echo "To install on device:"
echo "ssh root@$TARGET_IP"
echo "root@OpenWrt:~# chmod +x oasis_reflesh_install"
echo "root@OpenWrt:~# ./oasis_reflesh_install"
echo
